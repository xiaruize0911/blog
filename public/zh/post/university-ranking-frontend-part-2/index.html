<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构 | xiaruize's Blog</title><meta name=keywords content="React Native,Context API,React Query,状态管理,Vibe Coding"><meta name=description content="我们对 University Ranking Frontend 代码深度分析的第二部分。探索 ThemeContext 实现、LanguageContext、RankingsProvider 与 React Query，以及平台特定的优化。"><meta name=author content><link rel=canonical href=https://xiaruize.org/zh/post/university-ranking-frontend-part-2/><link crossorigin=anonymous href=/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css integrity="sha256-4fXEyuRFmWVff/lRlf+JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as=style><link rel=icon href=https://xiaruize.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://xiaruize.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://xiaruize.org/favicon-32x32.png><link rel=apple-touch-icon href=https://xiaruize.org/apple-touch-icon.png><link rel=mask-icon href=https://xiaruize.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://xiaruize.org/post/university-ranking-frontend-part-2/><link rel=alternate hreflang=zh href=https://xiaruize.org/zh/post/university-ranking-frontend-part-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://xiaruize.org/zh/post/university-ranking-frontend-part-2/"><meta property="og:site_name" content="xiaruize's Blog"><meta property="og:title" content="University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构"><meta property="og:description" content="我们对 University Ranking Frontend 代码深度分析的第二部分。探索 ThemeContext 实现、LanguageContext、RankingsProvider 与 React Query，以及平台特定的优化。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-12-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-12-07T00:00:00+00:00"><meta property="article:tag" content="React Native"><meta property="article:tag" content="Context API"><meta property="article:tag" content="React Query"><meta property="article:tag" content="状态管理"><meta property="article:tag" content="Vibe Coding"><meta name=twitter:card content="summary"><meta name=twitter:title content="University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构"><meta name=twitter:description content="我们对 University Ranking Frontend 代码深度分析的第二部分。探索 ThemeContext 实现、LanguageContext、RankingsProvider 与 React Query，以及平台特定的优化。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://xiaruize.org/zh/post/"},{"@type":"ListItem","position":2,"name":"University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构","item":"https://xiaruize.org/zh/post/university-ranking-frontend-part-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构","name":"University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构","description":"我们对 University Ranking Frontend 代码深度分析的第二部分。探索 ThemeContext 实现、LanguageContext、RankingsProvider 与 React Query，以及平台特定的优化。","keywords":["React Native","Context API","React Query","状态管理","Vibe Coding"],"articleBody":"这是我们 University Ranking Frontend 代码深度分析的第二部分。确保你已经阅读了 https://xiaruize.org/zh/post/university-ranking-frontend/ 和 https://xiaruize.org/zh/post/university-ranking-frontend-part-1/。\n概述 在第二部分，我们将探索：\nThemeContext - 实现带平台特定持久化的主题切换 LanguageContext - 管理国际化和语言偏好 RankingsProvider - 使用 React Query 进行后台数据同步 React Query Hooks - 构建可重用的数据获取模式 平台特定优化 - 不同方式处理 iOS、Android 和 Web ThemeContext：主题管理 ThemeContext 管理整个应用的视觉主题——浅色模式、深色模式或自动（跟随系统偏好）。以下是完整的实现：\n主题对象 export const lightTheme = { background: Platform.OS == 'android' ? '#ffffff' : '#f8f9fa', surface: '#ffffff', surfaceSecondary: '#f1f3f5', primary: '#4a90e2', text: '#2c3e50', textSecondary: '#6c757d', border: '#e1e5e9', card: '#ffffff', input: '#ffffff', shadow: '#000', }; export const darkTheme = { background: Platform.OS == 'android' ? '#121212' : '#121212', surface: '#1e1e1e', surfaceSecondary: '#434343ff', primary: '#4a90e2', text: '#ffffff', textSecondary: '#b0b0b0', border: '#333333', card: '#2a2a2a', input: '#2a2a2a', shadow: '#000', }; 注意： background 在 Android 和 iOS 之间不同。这是 Vibe Coding 的实际应用——当 AI 生成平台特定代码时，它经常发现手动编码可能错过的这种细微差别。\n带持久化的主题提供者 export const ThemeProvider = ({ children }) =\u003e { const systemColorScheme = useColorScheme(); const [themeMode, setThemeMode] = useState('auto'); // 'light', 'dark', 或 'auto' const [isLoading, setIsLoading] = useState(true); // 确定深色模式是否应该活跃 const isDarkMode = themeMode === 'auto' ? systemColorScheme === 'dark' : themeMode === 'dark'; // 启动时加载保存的主题偏好 useEffect(() =\u003e { let isMounted = true; const loadSavedThemePreference = async () =\u003e { try { if (Platform.OS === 'web') { const themePref = window.localStorage.getItem('themePreference'); if (themePref \u0026\u0026 isMounted) { setThemeMode(themePref); } } else { // 移动设备：使用文件系统 const profileFile = FileSystem.documentDirectory + 'user_profile.json'; const profileExists = await FileSystem.getInfoAsync(profileFile); if (profileExists.exists) { const profileContent = await FileSystem.readAsStringAsync(profileFile); const profile = JSON.parse(profileContent); if (profile.themePreference \u0026\u0026 isMounted) { setThemeMode(profile.themePreference); } } } } catch (error) { console.error('Error loading theme:', error); if (isMounted) setThemeMode('auto'); } finally { if (isMounted) setIsLoading(false); } }; loadSavedThemePreference(); return () =\u003e { isMounted = false; }; }, []); const toggleTheme = async () =\u003e { // 循环通过：light → dark → auto → light const nextMode = themeMode === 'light' ? 'dark' : themeMode === 'dark' ? 'auto' : 'light'; setThemeMode(nextMode); // 持久化到相应的存储 try { if (Platform.OS === 'web') { window.localStorage.setItem('themePreference', nextMode); } else { const profileFile = FileSystem.documentDirectory + 'user_profile.json'; let profile = { themePreference: nextMode, lastUpdated: new Date().toISOString() }; const profileExists = await FileSystem.getInfoAsync(profileFile); if (profileExists.exists) { const existingProfileContent = await FileSystem.readAsStringAsync(profileFile); const existingProfile = JSON.parse(existingProfileContent); profile = { ...existingProfile, themePreference: nextMode, lastUpdated: new Date().toISOString() }; } await FileSystem.writeAsStringAsync( profileFile, JSON.stringify(profile, null, 2) ); } } catch (error) { console.error('Error saving theme:', error); } }; const theme = isDarkMode ? darkTheme : lightTheme; return ( \u003cThemeContext.Provider value={{ theme, isDarkMode, toggleTheme }}\u003e {children} \u003c/ThemeContext.Provider\u003e ); }; 关键模式：\n平台检测 - 使用 Platform.OS 在 ‘web’、‘ios’、‘android’ 之间分支 存储抽象 - Web 使用 localStorage，移动设备使用文件系统 IsMounted 模式 - 防止在卸载的组件上状态更新 三态切换 - 循环 light → dark → auto 以获得更好的用户体验 使用主题 Hook 组件通过 hook 访问主题：\nfunction MyComponent() { const { theme, isDarkMode, toggleTheme } = useTheme(); return ( \u003cView style={{ backgroundColor: theme.background }}\u003e \u003cText style={{ color: theme.text }}\u003e内容\u003c/Text\u003e \u003cTouchableOpacity onPress={toggleTheme}\u003e \u003cText\u003e{isDarkMode ? 'Light' : 'Dark'} 模式\u003c/Text\u003e \u003c/TouchableOpacity\u003e \u003c/View\u003e ); } 这个模式使每个组件都能感知主题，无需 prop drilling。\nLanguageContext：国际化 LanguageContext 管理语言切换和设备语言检测：\nexport const LanguageProvider = ({ children }) =\u003e { const [currentLanguage, setCurrentLanguage] = useState(i18n.locale); const [isLoading, setIsLoading] = useState(true); // 启动时加载保存的语言偏好 useEffect(() =\u003e { let isMounted = true; const loadLanguagePreference = async () =\u003e { try { const savedLang = await loadSavedLanguagePreference(); if (savedLang \u0026\u0026 (savedLang === 'en' || savedLang === 'zh') \u0026\u0026 isMounted) { setCurrentLanguage(savedLang); i18n.locale = savedLang; } else if (isMounted) { // 回退：使用设备语言 const deviceLang = Localization.locale.startsWith('zh') ? 'zh' : 'en'; setCurrentLanguage(deviceLang); i18n.locale = deviceLang; } } catch (error) { console.error('Error loading language:', error); if (isMounted) { const deviceLang = Localization.locale.startsWith('zh') ? 'zh' : 'en'; setCurrentLanguage(deviceLang); i18n.locale = deviceLang; } } finally { if (isMounted) setIsLoading(false); } }; loadLanguagePreference(); return () =\u003e { isMounted = false; }; }, []); const switchLanguage = async (lang) =\u003e { if (lang === 'en' || lang === 'zh') { setCurrentLanguage(lang); i18n.locale = lang; await saveLanguagePreference(lang); } }; const contextValue = { currentLanguage, isChinese: currentLanguage === 'zh', switchLanguage, isLoading, }; return ( \u003cLanguageContext.Provider value={contextValue}\u003e {children} \u003c/LanguageContext.Provider\u003e ); }; 聪明的模式： 与其暴露原始语言字符串，我们提供 isChinese 布尔值。这使条件渲染更简单：\n// 在组件中： const { isChinese } = useLanguage(); {isChinese ? ( \u003cChineseVersionComponent /\u003e ) : ( \u003cEnglishVersionComponent /\u003e )} RankingsProvider：带缓存的 React Query RankingsProvider 是结合 React Query 与本地缓存的复杂示例：\nexport const RankingsProvider = ({ children }) =\u003e { // 使用 React Query 在后台获取数据 const { data: freshData, error, isLoading } = useRankingOptions(); const [rankingOptions, setRankingOptions] = useState([]); const [loading, setLoading] = useState(true); // 挂载时从本地缓存加载 useEffect(() =\u003e { let isMounted = true; const loadCache = async () =\u003e { try { let cachedData = null; if (Platform.OS === 'web') { const cached = window.localStorage.getItem('subjectRankingOptions'); if (cached) { cachedData = JSON.parse(cached); } } else { const cacheFile = FileSystem.documentDirectory + 'subject_ranking_options.json'; const info = await FileSystem.getInfoAsync(cacheFile); if (info.exists) { const cached = await FileSystem.readAsStringAsync(cacheFile); cachedData = JSON.parse(cached); } } if (isMounted \u0026\u0026 cachedData \u0026\u0026 Array.isArray(cachedData)) { setRankingOptions(cachedData); } if (isMounted) setLoading(false); } catch (e) { console.error('Error loading cache:', e); if (isMounted) setLoading(false); } }; loadCache(); return () =\u003e { isMounted = false; }; }, []); // 当来自 React Query 的新数据到达时更新缓存 useEffect(() =\u003e { let isMounted = true; const updateCache = async () =\u003e { if (!isMounted || !freshData || !Array.isArray(freshData) || freshData.length === 0) { return; } setRankingOptions(freshData); setLoading(false); try { if (Platform.OS === 'web') { window.localStorage.setItem('subjectRankingOptions', JSON.stringify(freshData)); } else { const cacheFile = FileSystem.documentDirectory + 'subject_ranking_options.json'; await FileSystem.writeAsStringAsync(cacheFile, JSON.stringify(freshData)); } } catch (e) { console.error('Error saving cache:', e); } }; if (!isLoading \u0026\u0026 freshData) { updateCache(); } return () =\u003e { isMounted = false; }; }, [freshData, isLoading]); return ( \u003cRankingsContext.Provider value={{ rankingOptions: rankingOptions || [], loading, error }}\u003e {children} \u003c/RankingsContext.Provider\u003e ); }; 架构见解： 这演示了 两层缓存策略：\n本地缓存（立即显示）- 来自文件系统/localStorage React Query 缓存（在后台更新）- 来自 API 服务器 当应用启动时：\n本地缓存立即加载 React Query 在后台获取新数据 当新数据到达时，本地缓存被更新 组件获得新数据而无延迟 这是 Vibe Coding 的卓越表现：AI 协助的方法认识到立即显示陈旧数据比在获取时显示什么都不显示更好。\nReact Query Hooks：可重用模式 在 lib/api.js 中，我们为不同的数据类型定义 React Query hooks：\nexport const useRankingOptions = (options = {}) =\u003e { return useQuery({ queryKey: ['rankingOptions'], queryFn: rawApi.getRankingOptions, staleTime: 30 * 60 * 1000, // 30 分钟 ...options }); }; export const useCountries = (options = {}) =\u003e { return useQuery({ queryKey: ['countries'], queryFn: rawApi.getCountries, staleTime: 60 * 60 * 1000, // 1 小时 ...options }); }; export const useUniversityDetails = (normalizedName, options = {}) =\u003e { return useQuery({ queryKey: ['universityDetails', normalizedName], queryFn: () =\u003e rawApi.getUniversityDetails(normalizedName), staleTime: 10 * 60 * 1000, // 10 分钟 enabled: !!normalizedName, // 仅在我们有名称时获取 ...options }); }; export const useSearchUniversities = ({ query, country, city, sort_credit }, options = {}) =\u003e { return useQuery({ queryKey: ['searchUniversities', { query, country, city, sort_credit }], queryFn: () =\u003e rawApi.searchUniversities({ query, country, city, sort_credit }), staleTime: 2 * 60 * 1000, // 2 分钟 enabled: !!(query || country || city || sort_credit), // 仅在参数存在时运行 ...options }); }; 关键模式：\nStale times 因数据类型而异：\n排名选项：30 分钟（很少改变） 国家：1 小时（静态数据） 大学详情：10 分钟（偶尔改变） 搜索结果：2 分钟（用户驱动） 通过 enabled 进行条件获取：\nenabled: !!normalizedName // 在我们有数据前不获取 查询密钥结构启用自动缓存管理：\nqueryKey: ['searchUniversities', { query, country, city, sort_credit }] // 对任何参数的更改自动失效缓存 使用 React Query Hooks 组件可以使用这些 hooks 进行复杂的数据管理：\nfunction RankingDetailComponent({ universityName, source }) { // 自动管理加载、错误和数据状态 const { data, isLoading, error } = useUniversityRankingsBySource( universityName, source ); if (isLoading) return \u003cActivityIndicator /\u003e; if (error) return \u003cText\u003eError loading rankings\u003c/Text\u003e; return ( \u003cFlatList data={data} renderItem={({ item }) =\u003e \u003cRankingItem item={item} /\u003e} keyExtractor={(item) =\u003e item.id} /\u003e ); } 平台特定优化 应用以不同的方式处理 iOS、Android 和 Web：\n存储策略 Web：\nwindow.localStorage.setItem('key', JSON.stringify(value)); 移动设备：\nimport * as FileSystem from 'expo-file-system'; const filePath = FileSystem.documentDirectory + 'myfile.json'; await FileSystem.writeAsStringAsync(filePath, JSON.stringify(value)); 为什么不同？ Web 没有 FileSystem，移动设备 localStorage 有大小限制。\nSafeAreaView 和 Insets function AppContentInner() { const insets = useSafeAreaInsets(); const paddingTop = Platform.OS === 'android' ? insets.top : 0; const paddingBottom = Platform.OS === 'android' ? insets.bottom : 0; return ( \u003cGestureHandlerRootView style={{ flex: 1, paddingTop, paddingBottom, backgroundColor: theme.surface }} \u003e {/* 内容 */} \u003c/GestureHandlerRootView\u003e ); } 原理： Android 尊重安全区域，但 iOS 不需要手动填充，因为 SafeAreaProvider 处理它。\n头部高度调整 const tabBarStyle = { backgroundColor: theme.surface, borderTopColor: theme.border, borderTopWidth: 1, paddingBottom: 0, height: 85, elevation: 0, // Android 阴影 shadowColor: 'transparent', // iOS 阴影 shadowOpacity: 0, shadowOffset: { height: 0 }, shadowRadius: 0, }; iOS（shadow*）和 Android（elevation）不同的阴影属性。\nVibe Coding 见解 1. Context + Hooks \u003e Props 通过 props 传递主题/语言需要在每个组件中梳理它们。Context + hooks 消除 prop drilling：\n// ❌ 没有 context \u003cApp theme={theme} language={language}\u003e \u003cNavigation theme={theme} language={language}\u003e \u003cScreen theme={theme} language={language}\u003e \u003cComponent theme={theme} language={language} /\u003e \u003c/Screen\u003e \u003c/Navigation\u003e \u003c/App\u003e // ✅ 使用 context \u003cThemeProvider\u003e \u003cLanguageProvider\u003e \u003cApp\u003e {/* 任何组件都可以 useTheme() 和 useLanguage() */} \u003c/App\u003e \u003c/LanguageProvider\u003e \u003c/ThemeProvider\u003e 2. React Query 启用离线优先 通过适当的 React Query 配置，屏幕可以立即显示缓存数据，然后在网络可用时在后台更新。这优于显示加载旋转器。\n3. 平台检测很务实 与其尝试为所有平台创建一个解决方案，检测平台并应用特定逻辑通常比抽象层更干净。\n总结 在第二部分，我们探索了：\n✅ 用于主题切换和平台特定持久化的 ThemeContext ✅ 用于智能语言管理的 LanguageContext ✅ 使用 React Query + 本地缓存的 RankingsProvider ✅ 用于不同数据类型的可重用 React Query hooks ✅ iOS、Android 和 Web 的平台特定优化 关键要点：将关注点分离为 context providers 使每个组件都更简单。通过在专用 contexts 中处理主题、语言和排名管理，SearchScreen 和 DetailPage 等屏幕可以纯粹专注于其业务逻辑。\n这是 Vibe Coding 的实践：使用 AI 协助设计干净、务实的解决方案，在整个平台上无缝工作，同时保持代码清晰度。\n","wordCount":"1377","inLanguage":"zh","datePublished":"2025-12-07T00:00:00Z","dateModified":"2025-12-07T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaruize.org/zh/post/university-ranking-frontend-part-2/"},"publisher":{"@type":"Organization","name":"xiaruize's Blog","logo":{"@type":"ImageObject","url":"https://xiaruize.org/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css integrity=sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js integrity=sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:!0},{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!0})})</script></head><body id="
    top"><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaruize.org/zh/ accesskey=h title="xiaruize's Blog (Alt + H)">xiaruize's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaruize.org/ title=English aria-label=English>En</a></li></ul></div></div><ul id=menu><li><a href=https://xiaruize.org/zh/categories/ title=categories><span>categories</span></a></li><li><a href=https://xiaruize.org/zh/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">University Ranking Frontend 深度分析（第二部分）：状态管理、React Query 和主题架构</h1><div class=post-description>我们对 University Ranking Frontend 代码深度分析的第二部分。探索 ThemeContext 实现、LanguageContext、RankingsProvider 与 React Query，以及平台特定的优化。</div><div class=post-meta><span title='2025-12-07 00:00:00 +0000 UTC'>2025年12月7日</span>&nbsp;|&nbsp;语言:<ul class=i18n_list><li><a href=https://xiaruize.org/post/university-ranking-frontend-part-2/>En</a></li></ul></div></header><div class=post-content><p>这是我们 University Ranking Frontend 代码深度分析的第二部分。确保你已经阅读了 https://xiaruize.org/zh/post/university-ranking-frontend/ 和 https://xiaruize.org/zh/post/university-ranking-frontend-part-1/。</p><h2 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h2><p>在第二部分，我们将探索：</p><ol><li><strong>ThemeContext</strong> - 实现带平台特定持久化的主题切换</li><li><strong>LanguageContext</strong> - 管理国际化和语言偏好</li><li><strong>RankingsProvider</strong> - 使用 React Query 进行后台数据同步</li><li><strong>React Query Hooks</strong> - 构建可重用的数据获取模式</li><li><strong>平台特定优化</strong> - 不同方式处理 iOS、Android 和 Web</li></ol><h2 id=themecontext主题管理>ThemeContext：主题管理<a hidden class=anchor aria-hidden=true href=#themecontext主题管理>#</a></h2><p><code>ThemeContext</code> 管理整个应用的视觉主题——浅色模式、深色模式或自动（跟随系统偏好）。以下是完整的实现：</p><h3 id=主题对象>主题对象<a hidden class=anchor aria-hidden=true href=#主题对象>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>lightTheme</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>background</span><span class=o>:</span> <span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>==</span> <span class=s1>&#39;android&#39;</span> <span class=o>?</span> <span class=s1>&#39;#ffffff&#39;</span> <span class=o>:</span> <span class=s1>&#39;#f8f9fa&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>surface</span><span class=o>:</span> <span class=s1>&#39;#ffffff&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>surfaceSecondary</span><span class=o>:</span> <span class=s1>&#39;#f1f3f5&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>primary</span><span class=o>:</span> <span class=s1>&#39;#4a90e2&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>:</span> <span class=s1>&#39;#2c3e50&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>textSecondary</span><span class=o>:</span> <span class=s1>&#39;#6c757d&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>border</span><span class=o>:</span> <span class=s1>&#39;#e1e5e9&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>card</span><span class=o>:</span> <span class=s1>&#39;#ffffff&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span><span class=o>:</span> <span class=s1>&#39;#ffffff&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>shadow</span><span class=o>:</span> <span class=s1>&#39;#000&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>darkTheme</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>background</span><span class=o>:</span> <span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>==</span> <span class=s1>&#39;android&#39;</span> <span class=o>?</span> <span class=s1>&#39;#121212&#39;</span> <span class=o>:</span> <span class=s1>&#39;#121212&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>surface</span><span class=o>:</span> <span class=s1>&#39;#1e1e1e&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>surfaceSecondary</span><span class=o>:</span> <span class=s1>&#39;#434343ff&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>primary</span><span class=o>:</span> <span class=s1>&#39;#4a90e2&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>:</span> <span class=s1>&#39;#ffffff&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>textSecondary</span><span class=o>:</span> <span class=s1>&#39;#b0b0b0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>border</span><span class=o>:</span> <span class=s1>&#39;#333333&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>card</span><span class=o>:</span> <span class=s1>&#39;#2a2a2a&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>input</span><span class=o>:</span> <span class=s1>&#39;#2a2a2a&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>shadow</span><span class=o>:</span> <span class=s1>&#39;#000&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><strong>注意：</strong> <code>background</code> 在 Android 和 iOS 之间不同。这是 <strong>Vibe Coding 的实际应用</strong>——当 AI 生成平台特定代码时，它经常发现手动编码可能错过的这种细微差别。</p><h3 id=带持久化的主题提供者>带持久化的主题提供者<a hidden class=anchor aria-hidden=true href=#带持久化的主题提供者>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>ThemeProvider</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>children</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>systemColorScheme</span> <span class=o>=</span> <span class=nx>useColorScheme</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[</span><span class=nx>themeMode</span><span class=p>,</span> <span class=nx>setThemeMode</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=s1>&#39;auto&#39;</span><span class=p>);</span> <span class=c1>// &#39;light&#39;, &#39;dark&#39;, 或 &#39;auto&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=p>[</span><span class=nx>isLoading</span><span class=p>,</span> <span class=nx>setIsLoading</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 确定深色模式是否应该活跃
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isDarkMode</span> <span class=o>=</span> <span class=nx>themeMode</span> <span class=o>===</span> <span class=s1>&#39;auto&#39;</span> 
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>systemColorScheme</span> <span class=o>===</span> <span class=s1>&#39;dark&#39;</span> 
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>themeMode</span> <span class=o>===</span> <span class=s1>&#39;dark&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动时加载保存的主题偏好
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>loadSavedThemePreference</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>===</span> <span class=s1>&#39;web&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>themePref</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;themePreference&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>themePref</span> <span class=o>&amp;&amp;</span> <span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>setThemeMode</span><span class=p>(</span><span class=nx>themePref</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 移动设备：使用文件系统
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kr>const</span> <span class=nx>profileFile</span> <span class=o>=</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>documentDirectory</span> <span class=o>+</span> <span class=s1>&#39;user_profile.json&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>profileExists</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>getInfoAsync</span><span class=p>(</span><span class=nx>profileFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>profileExists</span><span class=p>.</span><span class=nx>exists</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kr>const</span> <span class=nx>profileContent</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>readAsStringAsync</span><span class=p>(</span><span class=nx>profileFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=kr>const</span> <span class=nx>profile</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>profileContent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>themePreference</span> <span class=o>&amp;&amp;</span> <span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>setThemeMode</span><span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>themePreference</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error loading theme:&#39;</span><span class=p>,</span> <span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=nx>setThemeMode</span><span class=p>(</span><span class=s1>&#39;auto&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=nx>setIsLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>loadSavedThemePreference</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=p>[]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>toggleTheme</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 循环通过：light → dark → auto → light
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>nextMode</span> <span class=o>=</span> <span class=nx>themeMode</span> <span class=o>===</span> <span class=s1>&#39;light&#39;</span> 
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=s1>&#39;dark&#39;</span> 
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=nx>themeMode</span> <span class=o>===</span> <span class=s1>&#39;dark&#39;</span> 
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=s1>&#39;auto&#39;</span> 
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=s1>&#39;light&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nx>setThemeMode</span><span class=p>(</span><span class=nx>nextMode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 持久化到相应的存储
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>===</span> <span class=s1>&#39;web&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nb>window</span><span class=p>.</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>setItem</span><span class=p>(</span><span class=s1>&#39;themePreference&#39;</span><span class=p>,</span> <span class=nx>nextMode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>profileFile</span> <span class=o>=</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>documentDirectory</span> <span class=o>+</span> <span class=s1>&#39;user_profile.json&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nx>profile</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>themePreference</span><span class=o>:</span> <span class=nx>nextMode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>lastUpdated</span><span class=o>:</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>profileExists</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>getInfoAsync</span><span class=p>(</span><span class=nx>profileFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>profileExists</span><span class=p>.</span><span class=nx>exists</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>existingProfileContent</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>readAsStringAsync</span><span class=p>(</span><span class=nx>profileFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>existingProfile</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>existingProfileContent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>profile</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=p>...</span><span class=nx>existingProfile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nx>themePreference</span><span class=o>:</span> <span class=nx>nextMode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nx>lastUpdated</span><span class=o>:</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=p>};</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>writeAsStringAsync</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>profileFile</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>profile</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error saving theme:&#39;</span><span class=p>,</span> <span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>theme</span> <span class=o>=</span> <span class=nx>isDarkMode</span> <span class=o>?</span> <span class=nx>darkTheme</span> <span class=o>:</span> <span class=nx>lightTheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>ThemeContext</span><span class=p>.</span><span class=nx>Provider</span> <span class=nx>value</span><span class=o>=</span><span class=p>{{</span> <span class=nx>theme</span><span class=p>,</span> <span class=nx>isDarkMode</span><span class=p>,</span> <span class=nx>toggleTheme</span> <span class=p>}}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>children</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/ThemeContext.Provider&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><strong>关键模式：</strong></p><ol><li><strong>平台检测</strong> - 使用 <code>Platform.OS</code> 在 &lsquo;web&rsquo;、&lsquo;ios&rsquo;、&lsquo;android&rsquo; 之间分支</li><li><strong>存储抽象</strong> - Web 使用 localStorage，移动设备使用文件系统</li><li><strong>IsMounted 模式</strong> - 防止在卸载的组件上状态更新</li><li><strong>三态切换</strong> - 循环 light → dark → auto 以获得更好的用户体验</li></ol><h3 id=使用主题-hook>使用主题 Hook<a hidden class=anchor aria-hidden=true href=#使用主题-hook>#</a></h3><p>组件通过 hook 访问主题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>MyComponent</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>theme</span><span class=p>,</span> <span class=nx>isDarkMode</span><span class=p>,</span> <span class=nx>toggleTheme</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useTheme</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>View</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>backgroundColor</span><span class=o>:</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>background</span> <span class=p>}}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>Text</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>color</span><span class=o>:</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>text</span> <span class=p>}}</span><span class=o>&gt;</span><span class=nx>内容</span><span class=o>&lt;</span><span class=err>/Text&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>TouchableOpacity</span> <span class=nx>onPress</span><span class=o>=</span><span class=p>{</span><span class=nx>toggleTheme</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=o>&lt;</span><span class=nx>Text</span><span class=o>&gt;</span><span class=p>{</span><span class=nx>isDarkMode</span> <span class=o>?</span> <span class=s1>&#39;Light&#39;</span> <span class=o>:</span> <span class=s1>&#39;Dark&#39;</span><span class=p>}</span> <span class=nx>模式</span><span class=o>&lt;</span><span class=err>/Text&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=err>/TouchableOpacity&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/View&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这个模式使每个组件都能感知主题，无需 prop drilling。</p><h2 id=languagecontext国际化>LanguageContext：国际化<a hidden class=anchor aria-hidden=true href=#languagecontext国际化>#</a></h2><p><code>LanguageContext</code> 管理语言切换和设备语言检测：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>LanguageProvider</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>children</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[</span><span class=nx>currentLanguage</span><span class=p>,</span> <span class=nx>setCurrentLanguage</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=nx>i18n</span><span class=p>.</span><span class=nx>locale</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[</span><span class=nx>isLoading</span><span class=p>,</span> <span class=nx>setIsLoading</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 启动时加载保存的语言偏好
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>loadLanguagePreference</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>savedLang</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>loadSavedLanguagePreference</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>savedLang</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>savedLang</span> <span class=o>===</span> <span class=s1>&#39;en&#39;</span> <span class=o>||</span> <span class=nx>savedLang</span> <span class=o>===</span> <span class=s1>&#39;zh&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>setCurrentLanguage</span><span class=p>(</span><span class=nx>savedLang</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>i18n</span><span class=p>.</span><span class=nx>locale</span> <span class=o>=</span> <span class=nx>savedLang</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 回退：使用设备语言
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kr>const</span> <span class=nx>deviceLang</span> <span class=o>=</span> <span class=nx>Localization</span><span class=p>.</span><span class=nx>locale</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;zh&#39;</span><span class=p>)</span> <span class=o>?</span> <span class=s1>&#39;zh&#39;</span> <span class=o>:</span> <span class=s1>&#39;en&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=nx>setCurrentLanguage</span><span class=p>(</span><span class=nx>deviceLang</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>i18n</span><span class=p>.</span><span class=nx>locale</span> <span class=o>=</span> <span class=nx>deviceLang</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error loading language:&#39;</span><span class=p>,</span> <span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>deviceLang</span> <span class=o>=</span> <span class=nx>Localization</span><span class=p>.</span><span class=nx>locale</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;zh&#39;</span><span class=p>)</span> <span class=o>?</span> <span class=s1>&#39;zh&#39;</span> <span class=o>:</span> <span class=s1>&#39;en&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=nx>setCurrentLanguage</span><span class=p>(</span><span class=nx>deviceLang</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>i18n</span><span class=p>.</span><span class=nx>locale</span> <span class=o>=</span> <span class=nx>deviceLang</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=nx>setIsLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>loadLanguagePreference</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=p>[]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>switchLanguage</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>lang</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>lang</span> <span class=o>===</span> <span class=s1>&#39;en&#39;</span> <span class=o>||</span> <span class=nx>lang</span> <span class=o>===</span> <span class=s1>&#39;zh&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>setCurrentLanguage</span><span class=p>(</span><span class=nx>lang</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>i18n</span><span class=p>.</span><span class=nx>locale</span> <span class=o>=</span> <span class=nx>lang</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kr>await</span> <span class=nx>saveLanguagePreference</span><span class=p>(</span><span class=nx>lang</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>contextValue</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>currentLanguage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isChinese</span><span class=o>:</span> <span class=nx>currentLanguage</span> <span class=o>===</span> <span class=s1>&#39;zh&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>switchLanguage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>isLoading</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>LanguageContext</span><span class=p>.</span><span class=nx>Provider</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=nx>contextValue</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>children</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/LanguageContext.Provider&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><strong>聪明的模式：</strong> 与其暴露原始语言字符串，我们提供 <code>isChinese</code> 布尔值。这使条件渲染更简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 在组件中：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=p>{</span> <span class=nx>isChinese</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useLanguage</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nx>isChinese</span> <span class=o>?</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>ChineseVersionComponent</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>:</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>EnglishVersionComponent</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>)}</span>
</span></span></code></pre></div><h2 id=rankingsprovider带缓存的-react-query>RankingsProvider：带缓存的 React Query<a hidden class=anchor aria-hidden=true href=#rankingsprovider带缓存的-react-query>#</a></h2><p><code>RankingsProvider</code> 是结合 React Query 与本地缓存的复杂示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>RankingsProvider</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>children</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用 React Query 在后台获取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>data</span><span class=o>:</span> <span class=nx>freshData</span><span class=p>,</span> <span class=nx>error</span><span class=p>,</span> <span class=nx>isLoading</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useRankingOptions</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[</span><span class=nx>rankingOptions</span><span class=p>,</span> <span class=nx>setRankingOptions</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>([]);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>[</span><span class=nx>loading</span><span class=p>,</span> <span class=nx>setLoading</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useState</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 挂载时从本地缓存加载
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>loadCache</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kd>let</span> <span class=nx>cachedData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>===</span> <span class=s1>&#39;web&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>cached</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;subjectRankingOptions&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>cached</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>cachedData</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>cached</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>cacheFile</span> <span class=o>=</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>documentDirectory</span> <span class=o>+</span> <span class=s1>&#39;subject_ranking_options.json&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>info</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>getInfoAsync</span><span class=p>(</span><span class=nx>cacheFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>exists</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=kr>const</span> <span class=nx>cached</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>readAsStringAsync</span><span class=p>(</span><span class=nx>cacheFile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=nx>cachedData</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>cached</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span> <span class=o>&amp;&amp;</span> <span class=nx>cachedData</span> <span class=o>&amp;&amp;</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>cachedData</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>setRankingOptions</span><span class=p>(</span><span class=nx>cachedData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=nx>setLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error loading cache:&#39;</span><span class=p>,</span> <span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isMounted</span><span class=p>)</span> <span class=nx>setLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>loadCache</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=p>[]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 当来自 React Query 的新数据到达时更新缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>useEffect</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>updateCache</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isMounted</span> <span class=o>||</span> <span class=o>!</span><span class=nx>freshData</span> <span class=o>||</span> <span class=o>!</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>freshData</span><span class=p>)</span> <span class=o>||</span> <span class=nx>freshData</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>setRankingOptions</span><span class=p>(</span><span class=nx>freshData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>setLoading</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>===</span> <span class=s1>&#39;web&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nb>window</span><span class=p>.</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>setItem</span><span class=p>(</span><span class=s1>&#39;subjectRankingOptions&#39;</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>freshData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>cacheFile</span> <span class=o>=</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>documentDirectory</span> <span class=o>+</span> <span class=s1>&#39;subject_ranking_options.json&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>writeAsStringAsync</span><span class=p>(</span><span class=nx>cacheFile</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>freshData</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error saving cache:&#39;</span><span class=p>,</span> <span class=nx>e</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isLoading</span> <span class=o>&amp;&amp;</span> <span class=nx>freshData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>updateCache</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>isMounted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=p>[</span><span class=nx>freshData</span><span class=p>,</span> <span class=nx>isLoading</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>RankingsContext</span><span class=p>.</span><span class=nx>Provider</span> <span class=nx>value</span><span class=o>=</span><span class=p>{{</span>
</span></span><span class=line><span class=cl>            <span class=nx>rankingOptions</span><span class=o>:</span> <span class=nx>rankingOptions</span> <span class=o>||</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=nx>loading</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>error</span>
</span></span><span class=line><span class=cl>        <span class=p>}}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>children</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/RankingsContext.Provider&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><strong>架构见解：</strong> 这演示了 <strong>两层缓存策略</strong>：</p><ol><li><strong>本地缓存</strong>（立即显示）- 来自文件系统/localStorage</li><li><strong>React Query 缓存</strong>（在后台更新）- 来自 API 服务器</li></ol><p>当应用启动时：</p><ol><li>本地缓存立即加载</li><li>React Query 在后台获取新数据</li><li>当新数据到达时，本地缓存被更新</li><li>组件获得新数据而无延迟</li></ol><p>这是 <strong>Vibe Coding 的卓越表现</strong>：AI 协助的方法认识到立即显示陈旧数据比在获取时显示什么都不显示更好。</p><h2 id=react-query-hooks可重用模式>React Query Hooks：可重用模式<a hidden class=anchor aria-hidden=true href=#react-query-hooks可重用模式>#</a></h2><p>在 <code>lib/api.js</code> 中，我们为不同的数据类型定义 React Query hooks：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useRankingOptions</span> <span class=o>=</span> <span class=p>(</span><span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>useQuery</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryKey</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;rankingOptions&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryFn</span><span class=o>:</span> <span class=nx>rawApi</span><span class=p>.</span><span class=nx>getRankingOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>staleTime</span><span class=o>:</span> <span class=mi>30</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span> <span class=c1>// 30 分钟
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>...</span><span class=nx>options</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useCountries</span> <span class=o>=</span> <span class=p>(</span><span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>useQuery</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryKey</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;countries&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryFn</span><span class=o>:</span> <span class=nx>rawApi</span><span class=p>.</span><span class=nx>getCountries</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>staleTime</span><span class=o>:</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span> <span class=c1>// 1 小时
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>...</span><span class=nx>options</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useUniversityDetails</span> <span class=o>=</span> <span class=p>(</span><span class=nx>normalizedName</span><span class=p>,</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>useQuery</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryKey</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;universityDetails&#39;</span><span class=p>,</span> <span class=nx>normalizedName</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryFn</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>rawApi</span><span class=p>.</span><span class=nx>getUniversityDetails</span><span class=p>(</span><span class=nx>normalizedName</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>staleTime</span><span class=o>:</span> <span class=mi>10</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span> <span class=c1>// 10 分钟
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>enabled</span><span class=o>:</span> <span class=o>!!</span><span class=nx>normalizedName</span><span class=p>,</span> <span class=c1>// 仅在我们有名称时获取
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>...</span><span class=nx>options</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useSearchUniversities</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>country</span><span class=p>,</span> <span class=nx>city</span><span class=p>,</span> <span class=nx>sort_credit</span> <span class=p>},</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>useQuery</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryKey</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;searchUniversities&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>country</span><span class=p>,</span> <span class=nx>city</span><span class=p>,</span> <span class=nx>sort_credit</span> <span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=nx>queryFn</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nx>rawApi</span><span class=p>.</span><span class=nx>searchUniversities</span><span class=p>({</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>country</span><span class=p>,</span> <span class=nx>city</span><span class=p>,</span> <span class=nx>sort_credit</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>staleTime</span><span class=o>:</span> <span class=mi>2</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span> <span class=c1>// 2 分钟
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>enabled</span><span class=o>:</span> <span class=o>!!</span><span class=p>(</span><span class=nx>query</span> <span class=o>||</span> <span class=nx>country</span> <span class=o>||</span> <span class=nx>city</span> <span class=o>||</span> <span class=nx>sort_credit</span><span class=p>),</span> <span class=c1>// 仅在参数存在时运行
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>...</span><span class=nx>options</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><strong>关键模式：</strong></p><ol><li><p><strong>Stale times 因数据类型而异</strong>：</p><ul><li>排名选项：30 分钟（很少改变）</li><li>国家：1 小时（静态数据）</li><li>大学详情：10 分钟（偶尔改变）</li><li>搜索结果：2 分钟（用户驱动）</li></ul></li><li><p><strong>通过 <code>enabled</code> 进行条件获取</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>enabled</span><span class=o>:</span> <span class=o>!!</span><span class=nx>normalizedName</span>  <span class=c1>// 在我们有数据前不获取
</span></span></span></code></pre></div></li><li><p><strong>查询密钥结构</strong>启用自动缓存管理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>queryKey</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;searchUniversities&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>country</span><span class=p>,</span> <span class=nx>city</span><span class=p>,</span> <span class=nx>sort_credit</span> <span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=c1>// 对任何参数的更改自动失效缓存
</span></span></span></code></pre></div></li></ol><h3 id=使用-react-query-hooks>使用 React Query Hooks<a hidden class=anchor aria-hidden=true href=#使用-react-query-hooks>#</a></h3><p>组件可以使用这些 hooks 进行复杂的数据管理：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>RankingDetailComponent</span><span class=p>({</span> <span class=nx>universityName</span><span class=p>,</span> <span class=nx>source</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 自动管理加载、错误和数据状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>isLoading</span><span class=p>,</span> <span class=nx>error</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useUniversityRankingsBySource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>universityName</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=nx>source</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isLoading</span><span class=p>)</span> <span class=k>return</span> <span class=o>&lt;</span><span class=nx>ActivityIndicator</span> <span class=o>/&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=k>return</span> <span class=o>&lt;</span><span class=nx>Text</span><span class=o>&gt;</span><span class=nb>Error</span> <span class=nx>loading</span> <span class=nx>rankings</span><span class=o>&lt;</span><span class=err>/Text&gt;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>FlatList</span>
</span></span><span class=line><span class=cl>            <span class=nx>data</span><span class=o>=</span><span class=p>{</span><span class=nx>data</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>renderItem</span><span class=o>=</span><span class=p>{({</span> <span class=nx>item</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=o>&lt;</span><span class=nx>RankingItem</span> <span class=nx>item</span><span class=o>=</span><span class=p>{</span><span class=nx>item</span><span class=p>}</span> <span class=o>/&gt;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>keyExtractor</span><span class=o>=</span><span class=p>{(</span><span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=平台特定优化>平台特定优化<a hidden class=anchor aria-hidden=true href=#平台特定优化>#</a></h2><p>应用以不同的方式处理 iOS、Android 和 Web：</p><h3 id=存储策略>存储策略<a hidden class=anchor aria-hidden=true href=#存储策略>#</a></h3><p><strong>Web：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>setItem</span><span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>value</span><span class=p>));</span>
</span></span></code></pre></div><p><strong>移动设备：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=nx>as</span> <span class=nx>FileSystem</span> <span class=nx>from</span> <span class=s1>&#39;expo-file-system&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>filePath</span> <span class=o>=</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>documentDirectory</span> <span class=o>+</span> <span class=s1>&#39;myfile.json&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>FileSystem</span><span class=p>.</span><span class=nx>writeAsStringAsync</span><span class=p>(</span><span class=nx>filePath</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>value</span><span class=p>));</span>
</span></span></code></pre></div><p><strong>为什么不同？</strong> Web 没有 <code>FileSystem</code>，移动设备 localStorage 有大小限制。</p><h3 id=safeareaview-和-insets>SafeAreaView 和 Insets<a hidden class=anchor aria-hidden=true href=#safeareaview-和-insets>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>AppContentInner</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>insets</span> <span class=o>=</span> <span class=nx>useSafeAreaInsets</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>paddingTop</span> <span class=o>=</span> <span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>===</span> <span class=s1>&#39;android&#39;</span> <span class=o>?</span> <span class=nx>insets</span><span class=p>.</span><span class=nx>top</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>paddingBottom</span> <span class=o>=</span> <span class=nx>Platform</span><span class=p>.</span><span class=nx>OS</span> <span class=o>===</span> <span class=s1>&#39;android&#39;</span> <span class=o>?</span> <span class=nx>insets</span><span class=p>.</span><span class=nx>bottom</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>GestureHandlerRootView</span> 
</span></span><span class=line><span class=cl>            <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> 
</span></span><span class=line><span class=cl>                <span class=nx>flex</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=nx>paddingTop</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=nx>paddingBottom</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>backgroundColor</span><span class=o>:</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>surface</span> 
</span></span><span class=line><span class=cl>            <span class=p>}}</span>
</span></span><span class=line><span class=cl>        <span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=cm>/* 内容 */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/GestureHandlerRootView&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>原理：</strong> Android 尊重安全区域，但 iOS 不需要手动填充，因为 SafeAreaProvider 处理它。</p><h3 id=头部高度调整>头部高度调整<a hidden class=anchor aria-hidden=true href=#头部高度调整>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tabBarStyle</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>backgroundColor</span><span class=o>:</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>surface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>borderTopColor</span><span class=o>:</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>border</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>borderTopWidth</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>paddingBottom</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>height</span><span class=o>:</span> <span class=mi>85</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>elevation</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>           <span class=c1>// Android 阴影
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>shadowColor</span><span class=o>:</span> <span class=s1>&#39;transparent&#39;</span><span class=p>,</span> <span class=c1>// iOS 阴影
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>shadowOpacity</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>shadowOffset</span><span class=o>:</span> <span class=p>{</span> <span class=nx>height</span><span class=o>:</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>shadowRadius</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>iOS（shadow*）和 Android（elevation）不同的阴影属性。</p><h2 id=vibe-coding-见解>Vibe Coding 见解<a hidden class=anchor aria-hidden=true href=#vibe-coding-见解>#</a></h2><h3 id=1-context--hooks--props>1. Context + Hooks > Props<a hidden class=anchor aria-hidden=true href=#1-context--hooks--props>#</a></h3><p>通过 props 传递主题/语言需要在每个组件中梳理它们。Context + hooks 消除 prop drilling：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// ❌ 没有 context
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&lt;</span><span class=nx>App</span> <span class=nx>theme</span><span class=o>=</span><span class=p>{</span><span class=nx>theme</span><span class=p>}</span> <span class=nx>language</span><span class=o>=</span><span class=p>{</span><span class=nx>language</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>Navigation</span> <span class=nx>theme</span><span class=o>=</span><span class=p>{</span><span class=nx>theme</span><span class=p>}</span> <span class=nx>language</span><span class=o>=</span><span class=p>{</span><span class=nx>language</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>Screen</span> <span class=nx>theme</span><span class=o>=</span><span class=p>{</span><span class=nx>theme</span><span class=p>}</span> <span class=nx>language</span><span class=o>=</span><span class=p>{</span><span class=nx>language</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>Component</span> <span class=nx>theme</span><span class=o>=</span><span class=p>{</span><span class=nx>theme</span><span class=p>}</span> <span class=nx>language</span><span class=o>=</span><span class=p>{</span><span class=nx>language</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=err>/Screen&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=err>/Navigation&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/App&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ✅ 使用 context
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&lt;</span><span class=nx>ThemeProvider</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>LanguageProvider</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>App</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=cm>/* 任何组件都可以 useTheme() 和 useLanguage() */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=err>/App&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=err>/LanguageProvider&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/ThemeProvider&gt;</span>
</span></span></code></pre></div><h3 id=2-react-query-启用离线优先>2. React Query 启用离线优先<a hidden class=anchor aria-hidden=true href=#2-react-query-启用离线优先>#</a></h3><p>通过适当的 React Query 配置，屏幕可以立即显示缓存数据，然后在网络可用时在后台更新。这优于显示加载旋转器。</p><h3 id=3-平台检测很务实>3. 平台检测很务实<a hidden class=anchor aria-hidden=true href=#3-平台检测很务实>#</a></h3><p>与其尝试为所有平台创建一个解决方案，检测平台并应用特定逻辑通常比抽象层更干净。</p><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>在第二部分，我们探索了：</p><ul><li>✅ 用于主题切换和平台特定持久化的 ThemeContext</li><li>✅ 用于智能语言管理的 LanguageContext</li><li>✅ 使用 React Query + 本地缓存的 RankingsProvider</li><li>✅ 用于不同数据类型的可重用 React Query hooks</li><li>✅ iOS、Android 和 Web 的平台特定优化</li></ul><p>关键要点：<strong>将关注点分离为 context providers 使每个组件都更简单</strong>。通过在专用 contexts 中处理主题、语言和排名管理，SearchScreen 和 DetailPage 等屏幕可以纯粹专注于其业务逻辑。</p><p>这是 Vibe Coding 的实践：使用 AI 协助设计干净、务实的解决方案，在整个平台上无缝工作，同时保持代码清晰度。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaruize.org/zh/tags/react-native/>React Native</a></li><li><a href=https://xiaruize.org/zh/tags/context-api/>Context API</a></li><li><a href=https://xiaruize.org/zh/tags/react-query/>React Query</a></li><li><a href=https://xiaruize.org/zh/tags/%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86/>状态管理</a></li><li><a href=https://xiaruize.org/zh/tags/vibe-coding/>Vibe Coding</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://xiaruize.org/zh/>xiaruize's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>