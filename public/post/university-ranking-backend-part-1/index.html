<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>University Ranking Backend: Code Deep Dive (Part 1) | xiaruize's Blog</title><meta name=keywords content="Python,Flask,Backend,Code Analysis"><meta name=description content="In this post, we will dive deep into the code structure of the University Ranking Backend. We&rsquo;ll explore the entry point of the application and the core logic that powers the university search and filtering system.
üèóÔ∏è High-Level Overview
The backend follows a standard Model-View-Controller (MVC) pattern (where the &ldquo;View&rdquo; is JSON output).

app.py: The entry point that initializes the app and registers routes.
routes/: Handles HTTP requests, parses parameters, and delegates logic to models.
models/: Contains the business logic and database interactions.
db/: Manages the SQLite database connection.


1. The Entry Point: app.py
This file is the heart of the application. It sets up the Flask server, configures security, and connects all the moving parts."><meta name=author content><link rel=canonical href=https://xiaruize.org/post/university-ranking-backend-part-1/><link crossorigin=anonymous href=/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css integrity="sha256-4fXEyuRFmWVff/lRlf+JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as=style><link rel=icon href=https://xiaruize.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://xiaruize.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://xiaruize.org/favicon-32x32.png><link rel=apple-touch-icon href=https://xiaruize.org/apple-touch-icon.png><link rel=mask-icon href=https://xiaruize.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://xiaruize.org/post/university-ranking-backend-part-1/><link rel=alternate hreflang=zh href=https://xiaruize.org/zh/post/university-ranking-backend-part-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://xiaruize.org/post/university-ranking-backend-part-1/"><meta property="og:site_name" content="xiaruize's Blog"><meta property="og:title" content="University Ranking Backend: Code Deep Dive (Part 1)"><meta property="og:description" content="In this post, we will dive deep into the code structure of the University Ranking Backend. We‚Äôll explore the entry point of the application and the core logic that powers the university search and filtering system.
üèóÔ∏è High-Level Overview The backend follows a standard Model-View-Controller (MVC) pattern (where the ‚ÄúView‚Äù is JSON output).
app.py: The entry point that initializes the app and registers routes. routes/: Handles HTTP requests, parses parameters, and delegates logic to models. models/: Contains the business logic and database interactions. db/: Manages the SQLite database connection. 1. The Entry Point: app.py This file is the heart of the application. It sets up the Flask server, configures security, and connects all the moving parts."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-12-07T00:00:00+00:00"><meta property="article:modified_time" content="2025-12-07T00:00:00+00:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Flask"><meta property="article:tag" content="Backend"><meta property="article:tag" content="Code Analysis"><meta name=twitter:card content="summary"><meta name=twitter:title content="University Ranking Backend: Code Deep Dive (Part 1)"><meta name=twitter:description content="In this post, we will dive deep into the code structure of the University Ranking Backend. We&rsquo;ll explore the entry point of the application and the core logic that powers the university search and filtering system.
üèóÔ∏è High-Level Overview
The backend follows a standard Model-View-Controller (MVC) pattern (where the &ldquo;View&rdquo; is JSON output).

app.py: The entry point that initializes the app and registers routes.
routes/: Handles HTTP requests, parses parameters, and delegates logic to models.
models/: Contains the business logic and database interactions.
db/: Manages the SQLite database connection.


1. The Entry Point: app.py
This file is the heart of the application. It sets up the Flask server, configures security, and connects all the moving parts."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://xiaruize.org/post/"},{"@type":"ListItem","position":2,"name":"University Ranking Backend: Code Deep Dive (Part 1)","item":"https://xiaruize.org/post/university-ranking-backend-part-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"University Ranking Backend: Code Deep Dive (Part 1)","name":"University Ranking Backend: Code Deep Dive (Part 1)","description":"In this post, we will dive deep into the code structure of the University Ranking Backend. We\u0026rsquo;ll explore the entry point of the application and the core logic that powers the university search and filtering system.\nüèóÔ∏è High-Level Overview The backend follows a standard Model-View-Controller (MVC) pattern (where the \u0026ldquo;View\u0026rdquo; is JSON output).\napp.py: The entry point that initializes the app and registers routes. routes/: Handles HTTP requests, parses parameters, and delegates logic to models. models/: Contains the business logic and database interactions. db/: Manages the SQLite database connection. 1. The Entry Point: app.py This file is the heart of the application. It sets up the Flask server, configures security, and connects all the moving parts.\n","keywords":["Python","Flask","Backend","Code Analysis"],"articleBody":"In this post, we will dive deep into the code structure of the University Ranking Backend. We‚Äôll explore the entry point of the application and the core logic that powers the university search and filtering system.\nüèóÔ∏è High-Level Overview The backend follows a standard Model-View-Controller (MVC) pattern (where the ‚ÄúView‚Äù is JSON output).\napp.py: The entry point that initializes the app and registers routes. routes/: Handles HTTP requests, parses parameters, and delegates logic to models. models/: Contains the business logic and database interactions. db/: Manages the SQLite database connection. 1. The Entry Point: app.py This file is the heart of the application. It sets up the Flask server, configures security, and connects all the moving parts.\nFunction: Global Scope / if __name__ == \"__main__\": Input: None (executed on script start). Logic: Initialization: Creates the Flask application instance. CORS Setup: Applies CORS(app) to allow cross-origin requests. This is crucial because our frontend is hosted separately and needs permission to talk to this API. Blueprint Registration: It registers three main blueprints. Think of blueprints as ‚Äúplugins‚Äù that add specific routes to the app: universities_bp (at /universities) dropdown_bp (at /dropdown) ranking_detail_bp (at /subject_rankings) Execution: Starts the development server on port 10000. Output: A running HTTP server. from flask import Flask from routes.universities import universities_bp from routes.dropdown import dropdown_bp from routes.ranking_detail import ranking_detail_bp from flask_cors import CORS app = Flask(__name__) CORS(app) # Register blueprints app.register_blueprint(universities_bp, url_prefix=\"/universities\") app.register_blueprint(dropdown_bp, url_prefix=\"/dropdown\") app.register_blueprint(ranking_detail_bp, url_prefix=\"/subject_rankings\") if __name__ == \"__main__\": app.run(host='0.0.0.0', port=10000) 2. The Core Logic: models/universities.py This file contains the ‚Äúbrain‚Äù of the search feature. It handles the complex logic of searching, filtering, and sorting universities.\nFunction: filter_universities This is the most important function in the entire project. It dynamically builds SQL queries based on user input.\nInput:\nquery: Search keyword (e.g., ‚ÄúHarvard‚Äù). sort_credit: The ranking table to sort by (default: ‚ÄúUS News Global‚Äù). country: Filter by country. city: Filter by city. Logic:\nDatabase Connection: Connects to the SQLite database. Dynamic Table Selection (The ‚ÄúSmart‚Äù Part): It defaults to the global ranking table. Smart Feature: If a user selects a country (e.g., ‚ÄúChina‚Äù), the code checks if a specific table exists for that country (e.g., US_News_best global universities in china_Rankings). If it does, it automatically switches to that table for more accurate local rankings. Query Construction: It starts with a base SQL query selecting university details. It performs a LEFT JOIN with the selected ranking table to get the rank_value. Filtering: Appends WHERE clauses for the search query, country, and city. Sorting: Sorts results by rank_value (ASC) so the #1 university appears first. Output: A list of dictionaries, where each dictionary represents a university with its rank and details.\ndef filter_universities(query=None, sort_credit=None, country=None, city=None): conn = get_db_connection() if sort_credit is None: sort_credit = \"US_News_best global universities_Rankings\" # Smart Logic: Check for country-specific ranking table join_table = sort_credit if country: candidate_country = country.lower().strip() candidate_table = f\"US_News_best global universities in {candidate_country}_Rankings\" try: cur = conn.execute(\"SELECT name FROM sqlite_master WHERE type='table' AND name=?\", (candidate_table,)) if cur.fetchone(): join_table = candidate_table except Exception: join_table = sort_credit # Base Query sql = \"\"\" SELECT Universities.id, Universities.normalized_name, Universities.name, Universities.country, Universities.city, Universities.photo, R.rank_value, T.chinese_name FROM Universities LEFT JOIN University_names_en_to_zh AS T ON Universities.id = T.id \"\"\" # Dynamic Join if join_table: sql += f\"\"\" LEFT JOIN \"{join_table}\" AS R ON Universities.normalized_name = R.normalized_name \"\"\" # ... (Filtering logic for query, country, city) ... sql += \" ORDER BY R.rank_value ASC NULLS LAST LIMIT 200\" cursor = conn.execute(sql, params) return [dict(row) for row in cursor.fetchall()] 3. The API Layer: routes/universities.py This file acts as the ‚Äúreceptionist.‚Äù It receives requests from the internet and passes them to the models.\nFunction: filter_universities_route (GET /universities/filter) Input: URL Query parameters (query, sort_credit, country, city). Logic: Extracts these parameters from the request. Calls the models.universities.filter_universities function we described above. Wraps the result in a JSON response. Output: A JSON list of filtered universities. @universities_bp.route(\"/filter\", methods=[\"GET\"]) def filter_universities_route(): query = request.args.get(\"query\") sort_credit = request.args.get(\"sort_credit\") country = request.args.get(\"country\") city = request.args.get(\"city\") results = filter_universities(query, sort_credit, country, city) return jsonify(results) Function: get_university (GET /universities/) Input: univ_id (integer) from the URL. Logic: Fetches the full profile for a single university using its ID. Checks if the university exists. Output: A JSON object of the university profile, or a 404 error if not found. @universities_bp.route(\"/\", methods=[\"GET\"]) def get_university(univ_id): from models.university import get_university_by_id result = get_university_by_id(univ_id) if result: return jsonify(result) return jsonify({\"error\": \"University not found\"}), 404 üåä The Vibe Coding Perspective You might notice some interesting patterns here that were developed using ‚ÄúVibe Coding‚Äù‚Äîan AI-assisted development approach. The AI helped identify these patterns and optimize them for flow, adaptability, and extensibility.\nSmart Fallbacks \u0026 Auto-Discovery: In filter_universities, we don‚Äôt hardcode a list of supported countries or ranking tables. We simply ask the database, ‚ÄúDo you have a table for this?‚Äù (SELECT name FROM sqlite_master...).\nAI-Assisted Design: With AI assistance, we were able to quickly explore and implement this dynamic discovery pattern. The AI helped identify that querying sqlite_master was more maintainable than managing a configuration file. If I scrape a new country‚Äôs data tomorrow (e.g., ‚ÄúBest Universities in Mars‚Äù), I just drop the table into SQLite. The API automatically starts using it without a single line of code change. Lazy Imports: In routes/universities.py, you‚Äôll see imports inside the functions (e.g., from models.university import get_university_by_id).\nAI-Assisted Pattern: The AI suggested this pattern to avoid circular dependency headaches that often plague Flask applications. This approach, refined with AI assistance, lets developers move fast, refactor files, and copy-paste logic without breaking the app initialization. It‚Äôs about removing friction during development and making the codebase more maintainable. 4. Utility Routes: routes/dropdown.py These functions help the frontend build its UI by providing lists of options.\nFunction: get_countries (GET /dropdown/countries) Input: None. Logic: Scans the database to find all unique countries listed. Output: A JSON list of country names (e.g., [\"USA\", \"China\", \"UK\", ...]). @dropdown_bp.route('/countries', methods=['GET']) def get_countries(): from models.countries import get_countries_db countries = get_countries_db() return countries Function: get_ranking_options (GET /dropdown/ranking_options) Input: Optional filters like source or subject. Logic: Returns metadata about the available ranking tables. This tells the frontend what options to show in the ‚ÄúSort By‚Äù dropdown. Output: A JSON list of ranking categories. @dropdown_bp.route('/ranking_options', methods=['GET']) def get_ranking_options(): start_time = time() source = request.args.get('source') subject = request.args.get('subject') from models.ranking_options import ranking_options tables = ranking_options(source, subject) end_time = time() duration = end_time - start_time print(f\"Duration: {duration} seconds\") return jsonify(tables) ","wordCount":"1055","inLanguage":"en","datePublished":"2025-12-07T00:00:00Z","dateModified":"2025-12-07T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaruize.org/post/university-ranking-backend-part-1/"},"publisher":{"@type":"Organization","name":"xiaruize's Blog","logo":{"@type":"ImageObject","url":"https://xiaruize.org/favicon.ico"}}}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css integrity=sha384-zh0CIslj+VczCZtlzBcjt5ppRcsAmDnRem7ESsYwWwg3m/OaJ2l4x7YBZl9Kxxib crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js integrity=sha384-Rma6DA2IPUwhNxmrB/7S3Tno0YY7sFu9WSYMCuulLhIqYSGZ2gKCJWIqhBWqMQfh crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js integrity=sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:!0},{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"$",right:"$",display:!1}],throwOnError:!0})})</script></head><body id="
    top"><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://xiaruize.org/ accesskey=h title="xiaruize's Blog (Alt + H)">xiaruize's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://xiaruize.org/zh/ title=‰∏≠Êñá aria-label=‰∏≠Êñá>Zh</a></li></ul></div></div><ul id=menu><li><a href=https://xiaruize.org/categories/ title=categories><span>categories</span></a></li><li><a href=https://xiaruize.org/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">University Ranking Backend: Code Deep Dive (Part 1)</h1><div class=post-meta><span title='2025-12-07 00:00:00 +0000 UTC'>December 7, 2025</span>&nbsp;|&nbsp;Translations:<ul class=i18n_list><li><a href=https://xiaruize.org/zh/post/university-ranking-backend-part-1/>Zh</a></li></ul></div></header><div class=post-content><p>In this post, we will dive deep into the code structure of the <strong>University Ranking Backend</strong>. We&rsquo;ll explore the entry point of the application and the core logic that powers the university search and filtering system.</p><h2 id=-high-level-overview>üèóÔ∏è High-Level Overview<a hidden class=anchor aria-hidden=true href=#-high-level-overview>#</a></h2><p>The backend follows a standard <strong>Model-View-Controller (MVC)</strong> pattern (where the &ldquo;View&rdquo; is JSON output).</p><ul><li><strong><code>app.py</code></strong>: The entry point that initializes the app and registers routes.</li><li><strong><code>routes/</code></strong>: Handles HTTP requests, parses parameters, and delegates logic to models.</li><li><strong><code>models/</code></strong>: Contains the business logic and database interactions.</li><li><strong><code>db/</code></strong>: Manages the SQLite database connection.</li></ul><hr><h2 id=1-the-entry-point-apppy>1. The Entry Point: <code>app.py</code><a hidden class=anchor aria-hidden=true href=#1-the-entry-point-apppy>#</a></h2><p>This file is the heart of the application. It sets up the Flask server, configures security, and connects all the moving parts.</p><h3 id=function-global-scope--if-__name__--__main__>Function: Global Scope / <code>if __name__ == "__main__":</code><a hidden class=anchor aria-hidden=true href=#function-global-scope--if-__name__--__main__>#</a></h3><ul><li><strong>Input</strong>: None (executed on script start).</li><li><strong>Logic</strong>:<ol><li><strong>Initialization</strong>: Creates the <code>Flask</code> application instance.</li><li><strong>CORS Setup</strong>: Applies <code>CORS(app)</code> to allow cross-origin requests. This is crucial because our frontend is hosted separately and needs permission to talk to this API.</li><li><strong>Blueprint Registration</strong>: It registers three main blueprints. Think of blueprints as &ldquo;plugins&rdquo; that add specific routes to the app:<ul><li><code>universities_bp</code> (at <code>/universities</code>)</li><li><code>dropdown_bp</code> (at <code>/dropdown</code>)</li><li><code>ranking_detail_bp</code> (at <code>/subject_rankings</code>)</li></ul></li><li><strong>Execution</strong>: Starts the development server on port 10000.</li></ol></li><li><strong>Output</strong>: A running HTTP server.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask</span> <span class=kn>import</span> <span class=n>Flask</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>routes.universities</span> <span class=kn>import</span> <span class=n>universities_bp</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>routes.dropdown</span> <span class=kn>import</span> <span class=n>dropdown_bp</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>routes.ranking_detail</span> <span class=kn>import</span> <span class=n>ranking_detail_bp</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>flask_cors</span> <span class=kn>import</span> <span class=n>CORS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CORS</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Register blueprints</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>register_blueprint</span><span class=p>(</span><span class=n>universities_bp</span><span class=p>,</span> <span class=n>url_prefix</span><span class=o>=</span><span class=s2>&#34;/universities&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>register_blueprint</span><span class=p>(</span><span class=n>dropdown_bp</span><span class=p>,</span> <span class=n>url_prefix</span><span class=o>=</span><span class=s2>&#34;/dropdown&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>register_blueprint</span><span class=p>(</span><span class=n>ranking_detail_bp</span><span class=p>,</span> <span class=n>url_prefix</span><span class=o>=</span><span class=s2>&#34;/subject_rankings&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=s1>&#39;0.0.0.0&#39;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>10000</span><span class=p>)</span>
</span></span></code></pre></div><hr><h2 id=2-the-core-logic-modelsuniversitiespy>2. The Core Logic: <code>models/universities.py</code><a hidden class=anchor aria-hidden=true href=#2-the-core-logic-modelsuniversitiespy>#</a></h2><p>This file contains the &ldquo;brain&rdquo; of the search feature. It handles the complex logic of searching, filtering, and sorting universities.</p><h3 id=function-filter_universities>Function: <code>filter_universities</code><a hidden class=anchor aria-hidden=true href=#function-filter_universities>#</a></h3><p>This is the most important function in the entire project. It dynamically builds SQL queries based on user input.</p><ul><li><p><strong>Input</strong>:</p><ul><li><code>query</code>: Search keyword (e.g., &ldquo;Harvard&rdquo;).</li><li><code>sort_credit</code>: The ranking table to sort by (default: &ldquo;US News Global&rdquo;).</li><li><code>country</code>: Filter by country.</li><li><code>city</code>: Filter by city.</li></ul></li><li><p><strong>Logic</strong>:</p><ol><li><strong>Database Connection</strong>: Connects to the SQLite database.</li><li><strong>Dynamic Table Selection (The &ldquo;Smart&rdquo; Part)</strong>:<ul><li>It defaults to the global ranking table.</li><li><strong>Smart Feature</strong>: If a user selects a country (e.g., &ldquo;China&rdquo;), the code checks if a specific table exists for that country (e.g., <code>US_News_best global universities in china_Rankings</code>). If it does, it automatically switches to that table for more accurate local rankings.</li></ul></li><li><strong>Query Construction</strong>:<ul><li>It starts with a base SQL query selecting university details.</li><li>It performs a <code>LEFT JOIN</code> with the selected ranking table to get the <code>rank_value</code>.</li></ul></li><li><strong>Filtering</strong>: Appends <code>WHERE</code> clauses for the search query, country, and city.</li><li><strong>Sorting</strong>: Sorts results by <code>rank_value</code> (ASC) so the #1 university appears first.</li></ol></li><li><p><strong>Output</strong>: A list of dictionaries, where each dictionary represents a university with its rank and details.</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_universities</span><span class=p>(</span><span class=n>query</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>sort_credit</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>country</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>city</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>get_db_connection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>sort_credit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sort_credit</span> <span class=o>=</span> <span class=s2>&#34;US_News_best global universities_Rankings&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Smart Logic: Check for country-specific ranking table</span>
</span></span><span class=line><span class=cl>    <span class=n>join_table</span> <span class=o>=</span> <span class=n>sort_credit</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>country</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate_country</span> <span class=o>=</span> <span class=n>country</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>candidate_table</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;US_News_best global universities in </span><span class=si>{</span><span class=n>candidate_country</span><span class=si>}</span><span class=s2>_Rankings&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39; AND name=?&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>candidate_table</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>join_table</span> <span class=o>=</span> <span class=n>candidate_table</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>join_table</span> <span class=o>=</span> <span class=n>sort_credit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Base Query</span>
</span></span><span class=line><span class=cl>    <span class=n>sql</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        SELECT Universities.id, Universities.normalized_name, Universities.name,
</span></span></span><span class=line><span class=cl><span class=s2>               Universities.country, Universities.city, Universities.photo,
</span></span></span><span class=line><span class=cl><span class=s2>               R.rank_value, T.chinese_name
</span></span></span><span class=line><span class=cl><span class=s2>        FROM Universities
</span></span></span><span class=line><span class=cl><span class=s2>        LEFT JOIN University_names_en_to_zh AS T ON Universities.id = T.id
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Dynamic Join</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>join_table</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sql</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>            LEFT JOIN &#34;</span><span class=si>{</span><span class=n>join_table</span><span class=si>}</span><span class=s2>&#34; AS R
</span></span></span><span class=line><span class=cl><span class=s2>            ON Universities.normalized_name = R.normalized_name
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ... (Filtering logic for query, country, city) ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sql</span> <span class=o>+=</span> <span class=s2>&#34; ORDER BY R.rank_value ASC NULLS LAST LIMIT 200&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>cursor</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>sql</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=nb>dict</span><span class=p>(</span><span class=n>row</span><span class=p>)</span> <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>cursor</span><span class=o>.</span><span class=n>fetchall</span><span class=p>()]</span>
</span></span></code></pre></div><hr><h2 id=3-the-api-layer-routesuniversitiespy>3. The API Layer: <code>routes/universities.py</code><a hidden class=anchor aria-hidden=true href=#3-the-api-layer-routesuniversitiespy>#</a></h2><p>This file acts as the &ldquo;receptionist.&rdquo; It receives requests from the internet and passes them to the models.</p><h3 id=function-filter_universities_route-get-universitiesfilter>Function: <code>filter_universities_route</code> (<code>GET /universities/filter</code>)<a hidden class=anchor aria-hidden=true href=#function-filter_universities_route-get-universitiesfilter>#</a></h3><ul><li><strong>Input</strong>: URL Query parameters (<code>query</code>, <code>sort_credit</code>, <code>country</code>, <code>city</code>).</li><li><strong>Logic</strong>:<ol><li>Extracts these parameters from the request.</li><li>Calls the <code>models.universities.filter_universities</code> function we described above.</li><li>Wraps the result in a JSON response.</li></ol></li><li><strong>Output</strong>: A JSON list of filtered universities.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@universities_bp.route</span><span class=p>(</span><span class=s2>&#34;/filter&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;GET&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_universities_route</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;query&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sort_credit</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;sort_credit&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>country</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;country&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>city</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;city&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>filter_universities</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>sort_credit</span><span class=p>,</span> <span class=n>country</span><span class=p>,</span> <span class=n>city</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=function-get_university-get-universitiesintuniv_id>Function: <code>get_university</code> (<code>GET /universities/&lt;int:univ_id></code>)<a hidden class=anchor aria-hidden=true href=#function-get_university-get-universitiesintuniv_id>#</a></h3><ul><li><strong>Input</strong>: <code>univ_id</code> (integer) from the URL.</li><li><strong>Logic</strong>:<ol><li>Fetches the full profile for a single university using its ID.</li><li>Checks if the university exists.</li></ol></li><li><strong>Output</strong>: A JSON object of the university profile, or a 404 error if not found.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@universities_bp.route</span><span class=p>(</span><span class=s2>&#34;/&lt;int:univ_id&gt;&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;GET&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_university</span><span class=p>(</span><span class=n>univ_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>models.university</span> <span class=kn>import</span> <span class=n>get_university_by_id</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>get_university_by_id</span><span class=p>(</span><span class=n>univ_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>({</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;University not found&#34;</span><span class=p>}),</span> <span class=mi>404</span>
</span></span></code></pre></div><hr><h2 id=-the-vibe-coding-perspective>üåä The Vibe Coding Perspective<a hidden class=anchor aria-hidden=true href=#-the-vibe-coding-perspective>#</a></h2><p>You might notice some interesting patterns here that were developed using <strong>&ldquo;Vibe Coding&rdquo;</strong>‚Äîan AI-assisted development approach. The AI helped identify these patterns and optimize them for flow, adaptability, and extensibility.</p><ol><li><p><strong>Smart Fallbacks & Auto-Discovery</strong>:
In <code>filter_universities</code>, we don&rsquo;t hardcode a list of supported countries or ranking tables. We simply ask the database, <em>&ldquo;Do you have a table for this?&rdquo;</em> (<code>SELECT name FROM sqlite_master...</code>).</p><ul><li><strong>AI-Assisted Design</strong>: With AI assistance, we were able to quickly explore and implement this dynamic discovery pattern. The AI helped identify that querying <code>sqlite_master</code> was more maintainable than managing a configuration file. If I scrape a new country&rsquo;s data tomorrow (e.g., &ldquo;Best Universities in Mars&rdquo;), I just drop the table into SQLite. The API <em>automatically</em> starts using it without a single line of code change.</li></ul></li><li><p><strong>Lazy Imports</strong>:
In <code>routes/universities.py</code>, you&rsquo;ll see imports <em>inside</em> the functions (e.g., <code>from models.university import get_university_by_id</code>).</p><ul><li><strong>AI-Assisted Pattern</strong>: The AI suggested this pattern to avoid circular dependency headaches that often plague Flask applications. This approach, refined with AI assistance, lets developers move fast, refactor files, and copy-paste logic without breaking the app initialization. It&rsquo;s about removing friction during development and making the codebase more maintainable.</li></ul></li></ol><hr><h2 id=4-utility-routes-routesdropdownpy>4. Utility Routes: <code>routes/dropdown.py</code><a hidden class=anchor aria-hidden=true href=#4-utility-routes-routesdropdownpy>#</a></h2><p>These functions help the frontend build its UI by providing lists of options.</p><h3 id=function-get_countries-get-dropdowncountries>Function: <code>get_countries</code> (<code>GET /dropdown/countries</code>)<a hidden class=anchor aria-hidden=true href=#function-get_countries-get-dropdowncountries>#</a></h3><ul><li><strong>Input</strong>: None.</li><li><strong>Logic</strong>: Scans the database to find all unique countries listed.</li><li><strong>Output</strong>: A JSON list of country names (e.g., <code>["USA", "China", "UK", ...]</code>).</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dropdown_bp.route</span><span class=p>(</span><span class=s1>&#39;/countries&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_countries</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>models.countries</span> <span class=kn>import</span> <span class=n>get_countries_db</span>
</span></span><span class=line><span class=cl>    <span class=n>countries</span> <span class=o>=</span> <span class=n>get_countries_db</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>countries</span>
</span></span></code></pre></div><h3 id=function-get_ranking_options-get-dropdownranking_options>Function: <code>get_ranking_options</code> (<code>GET /dropdown/ranking_options</code>)<a hidden class=anchor aria-hidden=true href=#function-get_ranking_options-get-dropdownranking_options>#</a></h3><ul><li><strong>Input</strong>: Optional filters like <code>source</code> or <code>subject</code>.</li><li><strong>Logic</strong>: Returns metadata about the available ranking tables. This tells the frontend what options to show in the &ldquo;Sort By&rdquo; dropdown.</li><li><strong>Output</strong>: A JSON list of ranking categories.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dropdown_bp.route</span><span class=p>(</span><span class=s1>&#39;/ranking_options&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_ranking_options</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>subject</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;subject&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>models.ranking_options</span> <span class=kn>import</span> <span class=n>ranking_options</span>
</span></span><span class=line><span class=cl>    <span class=n>tables</span> <span class=o>=</span> <span class=n>ranking_options</span><span class=p>(</span><span class=n>source</span><span class=p>,</span> <span class=n>subject</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Duration: </span><span class=si>{</span><span class=n>duration</span><span class=si>}</span><span class=s2> seconds&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>jsonify</span><span class=p>(</span><span class=n>tables</span><span class=p>)</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://xiaruize.org/tags/python/>Python</a></li><li><a href=https://xiaruize.org/tags/flask/>Flask</a></li><li><a href=https://xiaruize.org/tags/backend/>Backend</a></li><li><a href=https://xiaruize.org/tags/code-analysis/>Code Analysis</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://xiaruize.org/>xiaruize's Blog</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>